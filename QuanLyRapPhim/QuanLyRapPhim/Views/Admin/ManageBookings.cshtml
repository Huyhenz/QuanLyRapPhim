@model IEnumerable<QuanLyRapPhim.Models.Booking>
@using QuanLyRapPhim.Models
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = "Manage Bookings";
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool isAdmin = User.IsInRole("Admin");
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />

<div class="container-fluid d-flex position-relative">
    @* ========== CHRISTMAS DASHBOARD ========== *@
    @await Html.PartialAsync("_ChristmasDashboard")

    <!-- MAIN CONTENT -->
    <div class="frame-wrapper flex-grow-1 @(isAdmin ? "admin-view" : "")">
        <div class="content-inner">
            <h1 class="title-gradient">Manage Bookings</h1>

            <div class="table-responsive">
                <table class="table table-dark table-hover glow-effect">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Customer</th>
                            <th>Movie</th>
                            <th>Room</th>
                            <th>Seats</th>
                            <th>Show Date</th>
                            <th>Show Time</th>
                            <th>Food/Drinks</th>
                            <th>Amount</th>
                            <th>Voucher</th>
                            <th>Booking Date</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model?.Any() == true)
                        {
                            @foreach (var booking in Model)
                            {
                                var showtime = booking.Showtime;
                                var isFoodOnly = showtime == null;
                                var payment = booking.Payment;
                                var displayAmount = (booking.FinalAmount ?? 0m) > 0m ? (booking.FinalAmount ?? 0m) : (booking.TotalPrice ?? 0m);
                                var hasDiscount = !string.IsNullOrEmpty(booking.VoucherUsed) && (booking.FinalAmount ?? 0m) < (booking.TotalPrice ?? 0m) && (booking.FinalAmount ?? 0m) > 0m;
                                var discountAmount = hasDiscount ? ((booking.TotalPrice ?? 0m) - (booking.FinalAmount ?? 0m)) : 0m;

                                <tr class="text-center align-middle">
                                    <td class="fw-bold text-info">#@booking.BookingId</td>
                                    <td>@(booking.User?.FullName ?? booking.User?.Email ?? "Guest")</td>
                                    <td>
                                        @(isFoodOnly ? "Food Only" : showtime.Movie.Title)
                                    </td>
                                    <td>@(isFoodOnly ? "—" : showtime.Room.RoomName)</td>
                                    <td>
                                        @(booking.BookingDetails?.Any() == true
                                            ? string.Join(", ", booking.BookingDetails.Select(bd => bd.Seat.SeatNumber))
                                            : Html.Raw("<em class='text-muted'>—</em>"))
                                    </td>
                                    <td>@(isFoodOnly ? "—" : showtime.Date.ToString("dd/MM/yyyy"))</td>
                                    <td>@(isFoodOnly ? "—" : showtime.StartTime.ToString(@"hh\:mm"))</td>
                                    <td>
                                        @if (booking.BookingFoods?.Any() == true)
                                        {
                                            <div class="text-start">
                                                @foreach (var bf in booking.BookingFoods)
                                                {
                                                    <div>@bf.FoodItem.Name × @bf.Quantity</div>
                                                }
                                            </div>
                                        }
                                        else
                                        {
                                            <em class="text-muted">None</em>
                                        }
                                    </td>
                                    <td class="text-end text-warning fw-bold fs-5">
                                        @(displayAmount.ToString("N0") ?? "0") <small class="text-white-50">VND</small>
                                        @if (hasDiscount)
                                        {
                                            <br />
                                            <small class="text-success">(Saved @(discountAmount.ToString("N0") ?? "0") VND from voucher)</small>
                                        }
                                    </td>
                                    <td>
                                        @(booking.VoucherUsed ?? "—")
                                    </td>
                                    <td>@booking.BookingDate.ToString("dd/MM/yyyy")<br><small>@booking.BookingDate.ToString("HH:mm")</small></td>
                                    <td>
                                        @if (payment != null)
                                        {
                                            var badgeClass = PaymentStatus.GetBadgeClass(payment.PaymentStatus);
                                            var displayText = PaymentStatus.GetDisplayText(payment.PaymentStatus, "en");

                                            <span class="badge @badgeClass px-3 py-2">@displayText</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary px-3 py-2">No Payment</span>
                                        }
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="12" class="text-center py-5">
                                    <i class="fas fa-receipt fa-3x mb-3 text-muted"></i><br>
                                    <em class="text-muted fs-4">No bookings found</em>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <div class="text-center mt-5">
                <a asp-controller="Admin" asp-action="Index" class="btn btn-back glow-effect">
                    <i class="fas fa-home me-2"></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <footer class="footer text-center py-3">
        <p class="text-white mb-0">© 2025 CinemaX. All rights reserved.</p>
    </footer>
</div>

<style>
    body {
        background-color: #0F0F0F;
        color: white;
        font-family: 'Montserrat', sans-serif;
    }

    /* ==================== CONTENT WRAPPER ==================== */
    .content-inner {
        max-width: 1400px;
        width: 100%;
        padding: 30px;
    }

    /* ==================== TITLE ==================== */
    .title-gradient {
        background: linear-gradient(90deg, #ff0033, #ff8c00);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 40px;
    }

    /* ==================== TABLE STYLING ==================== */
    .table-dark {
        background-color: #1c1c1c;
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid var(--christmas-gold, #FFD700);
    }

        .table-dark th {
            background-color: #2a2a2a;
            font-weight: 600;
            text-align: center;
            border-bottom: 2px solid var(--christmas-gold, #FFD700);
            color: var(--christmas-gold, #FFD700);
        }

        .table-dark td {
            vertical-align: middle;
            text-align: center;
            color: white;
        }

        .table-dark tbody tr:hover {
            background-color: rgba(255, 215, 0, 0.1);
        }

    /* ==================== BADGES ==================== */
    .badge {
        font-weight: 600;
        padding: 8px 16px;
        border-radius: 20px;
    }

    .badge-success {
        background-color: #28a745;
    }

    /* ==================== BUTTONS ==================== */
    .btn-back {
        background: linear-gradient(45deg, #ff0033, #cc002a);
        border: none;
        color: white;
        padding: 14px 40px;
        border-radius: 30px;
        font-weight: 600;
        font-size: 1.1rem;
        transition: all 0.3s ease;
    }

        .btn-back:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255,0,51,0.4);
        }

    /* ==================== EFFECTS ==================== */
    .glow-effect {
        box-shadow: 0 0 20px rgba(255,0,51,0.3);
        transition: all 0.3s ease;
    }

        .glow-effect:hover {
            box-shadow: 0 0 30px rgba(255,0,51,0.6);
        }

    .text-muted {
        color: #aaaaaa !important;
        font-style: italic;
    }

    /* ==================== RESPONSIVE ==================== */
    @@media (max-width: 768px) {
        .title-gradient

    {
        font-size: 2rem;
    }

    .content-inner {
        padding: 20px;
    }

    .table-dark {
        font-size: 0.9rem;
    }

    .btn-back {
        padding: 12px 30px;
        font-size: 1rem;
    }

    }

    @@  media (max-width: 576px) {
        .title-gradient

    {
        font-size: 1.5rem;
    }

    .table-dark th,
    .table-dark td {
        padding: 8px;
        font-size: 0.85rem;
    }

    }
</style>