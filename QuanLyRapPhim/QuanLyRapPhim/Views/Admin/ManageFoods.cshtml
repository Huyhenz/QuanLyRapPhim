@model IEnumerable<QuanLyRapPhim.Models.FoodItem>
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["ManageFoods"].Value;
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool isAdmin = User.IsInRole("Admin");
}

<script>
    const i18n = {
        SizeS: '@Localizer["SizeS"]',
        SizeM: '@Localizer["SizeM"]',
        SizeL: '@Localizer["SizeL"]',
        CategoryPopcorn: '@Localizer["CategoryPopcorn"]',
        CategoryDrink: '@Localizer["CategoryDrink"]',
        CategoryCombo: '@Localizer["CategoryCombo"]',
        NoImage: '@Localizer["NoImage"]',
        DeleteConfirm: '@Localizer["DeleteConfirm"]',
        CreateSuccess: '@Localizer["CreateSuccess"]',
        EditSuccess: '@Localizer["EditSuccess"]',
        DeleteSuccess: '@Localizer["DeleteSuccess"]',
        ServerError: '@Localizer["ServerError"]'
    };
</script>

<div class="container-fluid d-flex position-relative">
    @await Html.PartialAsync("_ChristmasDashboard")

    <div class="frame-wrapper flex-grow-1 @(isAdmin ? "admin-view" : "")">
        <div class="content-inner">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="page-title">
                    <span class="christmas-icon">🍿</span>
                    @Localizer["ManageFoods"]
                    <span class="christmas-icon">🥤</span>
                </h2>
                <button class="btn btn-success christmas-btn rounded-pill px-4" data-bs-toggle="modal" data-bs-target="#createFoodModal">
                    <i class="fas fa-plus"></i> @Localizer["AddNewFoodItem"]
                </button>
            </div>

            <div id="alert-container"></div>

            <div class="table-responsive">
                <table class="table table-dark table-striped christmas-table" id="foodsTable">
                    <thead class="table-danger">
                        <tr>
                            <th style="width: 80px;">@Localizer["FoodImage"]</th>
                            <th>@Localizer["FoodName"]</th>
                            <th style="width: 60px;">@Localizer["FoodSize"]</th>
                            <th style="width: 120px;">@Localizer["FoodPrice"]</th>
                            <th style="width: 100px;">@Localizer["FoodCategory"]</th>
                            <th style="width: 140px;" class="text-center">@Localizer["Actions"]</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Create -->
<div class="modal fade" id="createFoodModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="createFoodForm" enctype="multipart/form-data">
            <div class="modal-content christmas-modal">
                <div class="modal-header">
                    <h5 class="modal-title">🎄 @Localizer["AddNewFoodItem"]</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodName"]</label>
                            <input type="text" name="Name" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodSize"]</label>
                            <select name="Size" class="form-select">
                                <option value="S">S</option>
                                <option value="M" selected>M</option>
                                <option value="L">L</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodPrice"] (VND)</label>
                            <input type="number" name="Price" class="form-control" min="0" step="1000" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodCategory"]</label>
                            <select name="Category" class="form-select">
                                <option value="Bắp">Bắp rang</option>
                                <option value="Nước">Nước uống</option>
                                <option value="Combo">Combo</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">@Localizer["FoodImage"]</label>
                            <input type="file" name="imageFile" class="form-control" accept="image/*" />
                            <small class="text-muted">Tối đa 2MB, định dạng JPG/PNG</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="submit" class="btn btn-success christmas-btn">@Localizer["Add"]</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal: Edit -->
<div class="modal fade" id="editFoodModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <form id="editFoodForm" enctype="multipart/form-data">
            <input type="hidden" name="foodItemId" />
            <div class="modal-content christmas-modal">
                <div class="modal-header">
                    <h5 class="modal-title">🎅 @Localizer["EditFoodItem"]</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodName"]</label>
                            <input type="text" name="name" class="form-control" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodSize"]</label>
                            <select name="size" class="form-select">
                                <option value="S">S</option>
                                <option value="M">M</option>
                                <option value="L">L</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodPrice"] (VND)</label>
                            <input type="number" name="price" class="form-control" min="0" step="1000" required />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">@Localizer["FoodCategory"]</label>
                            <select name="category" class="form-select">
                                <option value="Bắp">Bắp rang</option>
                                <option value="Nước">Nước uống</option>
                                <option value="Combo">Combo</option>
                            </select>
                        </div>
                        <div class="col-12">
                            <label class="form-label">@Localizer["CurrentImage"]</label>
                            <div id="currentImage" class="mb-2"></div>
                            <input type="file" name="imageFile" class="form-control" accept="image/*" />
                            <small class="text-muted">Để trống nếu không muốn thay đổi ảnh</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">@Localizer["Cancel"]</button>
                    <button type="submit" class="btn btn-primary christmas-btn">@Localizer["Update"]</button>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
    body {
        margin: 0;
        background-color: #0F0F0F;
        color: #ffffff;
        font-family: 'Montserrat', sans-serif;
        overflow-x: hidden;
    }

    .page-title {
        background: linear-gradient(90deg, #FFD700, #FF4500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 2rem;
        font-weight: 700;
        text-align: center;
        margin: 0;
    }

    .christmas-icon {
        font-size: 2rem;
        animation: bounce 2s infinite;
    }

    .christmas-table {
        background-color: #1c1c1c;
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid #FFD700;
    }

        .christmas-table th {
            background: linear-gradient(135deg, #8B0000, #165B33);
            color: #FFFAFA;
            font-weight: 600;
        }

        .christmas-table td {
            color: white;
        }

        .christmas-table tr:hover {
            background: linear-gradient(90deg, rgba(139, 0, 0, 0.3), rgba(22, 91, 51, 0.3));
        }

    .christmas-btn {
        background: linear-gradient(135deg, #C41E3A, #165B33);
        border: 2px solid #FFD700;
        color: white;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .christmas-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.6);
        }

    .christmas-modal {
        background: linear-gradient(180deg, #8B0000, #165B33);
        border: 3px solid #FFD700;
        color: #FFFAFA;
    }

        .christmas-modal .modal-header {
            border-bottom: 2px solid #FFD700;
        }

        .christmas-modal .form-label {
            color: #FFD700;
            font-weight: 600;
        }

        .christmas-modal .form-control,
        .christmas-modal .form-select {
            background-color: rgba(0, 0, 0, 0.3);
            border: 1px solid #FFD700;
            color: #FFFAFA;
        }

            .christmas-modal .form-control:focus,
            .christmas-modal .form-select:focus {
                background-color: rgba(0, 0, 0, 0.5);
                border-color: #FFD700;
                color: #FFFAFA;
                box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            }

    @@keyframes bounce {
        0%, 100%

    {
        transform: translateY(0);
    }

    50% {
        transform: translateY(-5px);
    }

    }
</style>

@section Scripts {
    <script>
        function showAlert(msg, type = 'success') {
            $('#alert-container').html(`
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    ${msg}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>`);
            setTimeout(() => $('.alert').alert('close'), 4000);
        }

        function loadFoods() {
            $.get('/Admin/GetFoodItems')
                .done(data => {
                    $('#foodsTable tbody').empty();
                    if (data.length === 0) {
                        $('#foodsTable tbody').append('<tr><td colspan="6" class="text-center text-muted">Chưa có món ăn nào</td></tr>');
                        return;
                    }
                    data.forEach(f => {
                        const img = f.imageUrl
                            ? `<img src="${f.imageUrl}?t=${Date.now()}" class="img-thumbnail" style="width:50px;height:50px;object-fit:cover;">`
                            : `<div class="bg-secondary text-white d-flex align-items-center justify-content-center rounded" style="width:50px;height:50px;"><i class="fas fa-utensils"></i></div>`;

                        const sizeDisplay = f.size === 'S' ? i18n.SizeS : f.size === 'M' ? i18n.SizeM : i18n.SizeL;
                        const catDisplay = f.category === 'Bắp' ? i18n.CategoryPopcorn : f.category === 'Nước' ? i18n.CategoryDrink : i18n.CategoryCombo;
                        const badgeClass = f.category === 'Combo' ? 'warning' : f.category === 'Bắp' ? 'success' : 'primary';

                        $('#foodsTable tbody').append(`
                            <tr data-id="${f.foodItemId}">
                                <td>${img}</td>
                                <td class="fw-bold">${f.name}</td>
                                <td><span class="badge bg-info">${sizeDisplay}</span></td>
                                <td class="text-warning">${parseInt(f.price).toLocaleString()}đ</td>
                                <td><span class="badge bg-${badgeClass}">${catDisplay}</span></td>
                                <td class="text-center">
                                    <button class="btn btn-warning btn-sm edit-btn me-1">Sửa</button>
                                    <button class="btn btn-danger btn-sm delete-btn">Xóa</button>
                                </td>
                            </tr>
                        `);
                    });
                })
                .fail(() => showAlert('Lỗi tải dữ liệu!', 'danger'));
        }

        $('#createFoodForm').submit(function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/Admin/CreateFood',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: res => {
                    if (res.success) {
                        $('#createFoodModal').modal('hide');
                        this.reset();
                        loadFoods();
                        showAlert(res.message);
                    } else {
                        showAlert(res.message || 'Thêm thất bại!', 'danger');
                    }
                },
                error: () => showAlert(i18n.ServerError, 'danger')
            });
        });

        $(document).on('click', '.edit-btn', function () {
            const id = $(this).closest('tr').data('id');
            $.get('/Admin/GetFoodItem?id=' + id)
                .done(food => {
                    $('#editFoodForm [name="foodItemId"]').val(food.foodItemId);
                    $('#editFoodForm [name="name"]').val(food.name);
                    $('#editFoodForm [name="size"]').val(food.size);
                    $('#editFoodForm [name="price"]').val(food.price);
                    $('#editFoodForm [name="category"]').val(food.category);
                    $('#currentImage').html(food.imageUrl
                        ? `<img src="${food.imageUrl}?t=${Date.now()}" class="img-thumbnail" style="max-height: 100px;">`
                        : '<em class="text-muted">' + i18n.NoImage + '</em>'
                    );
                    $('#editFoodModal').modal('show');
                })
                .fail(() => showAlert('Lỗi tải dữ liệu món ăn!', 'danger'));
        });

        $('#editFoodForm').submit(function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            $.ajax({
                url: '/Admin/EditFood',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: res => {
                    if (res.success) {
                        $('#editFoodModal').modal('hide');
                        loadFoods();
                        showAlert(res.message);
                    } else {
                        showAlert(res.message || 'Cập nhật thất bại!', 'danger');
                    }
                },
                error: () => showAlert(i18n.ServerError, 'danger')
            });
        });

        $(document).on('click', '.delete-btn', function () {
            const id = $(this).closest('tr').data('id');
            if (confirm(i18n.DeleteConfirm)) {
                $.post('/Admin/DeleteFood', { id: id }, res => {
                    if (res.success) {
                        loadFoods();
                        showAlert(res.message);
                    } else {
                        showAlert(res.message || 'Xóa thất bại!', 'danger');
                    }
                }).fail(() => showAlert(i18n.ServerError, 'danger'));
            }
        });

        $(document).ready(loadFoods);
    </script>
}