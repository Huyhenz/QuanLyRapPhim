@model dynamic
@using Newtonsoft.Json
@using System.Collections.Generic
@using System.Globalization
@using System.Linq
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer
@{
    ViewData["Title"] = Localizer["RevenueStatistics"].Value;
    Layout = "~/Views/Shared/_Layout.cshtml";
    bool isAdmin = User.IsInRole("Admin");
}

<div class="container-fluid d-flex position-relative">
    @await Html.PartialAsync("_ChristmasDashboard")

    <div class="frame-wrapper flex-grow-1 @(isAdmin ? "admin-view" : "")">
        <div class="content-inner">
            <h2 class="page-title">
                <span class="christmas-icon">📊</span>
                @Localizer["RevenueStatistics"]
                <span class="christmas-icon">💰</span>
            </h2>

            <div class="header-actions">
                <span class="order-count">@Localizer["RevenueDataOverview"]</span>
                <div class="date-filter">
                    <form id="dateFilterForm" method="get" action="@Url.Action("RevenueStatistics")">
                        <input type="hidden" name="fromDate" id="fromDateInput" value="@(((dynamic)ViewBag.RevenueData)?.FromDate ?? DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd"))">
                        <input type="hidden" name="toDate" id="toDateInput" value="@(((dynamic)ViewBag.RevenueData)?.ToDate ?? DateTime.Now.ToString("yyyy-MM-dd"))">
                        <span>@Localizer["From"]</span>
                        <input type="date" class="date-input" id="fromDate" onchange="updateFilter()">
                        <span>@Localizer["To"]</span>
                        <input type="date" class="date-input" id="toDate" onchange="updateFilter()">
                        <button type="submit" class="filter-btn christmas-btn">@Localizer["Filter"]</button>
                    </form>
                </div>
            </div>

            <div id="alert-container" class="mb-4"></div>

            <!-- Revenue Summary -->
            <div class="admin-section">
                <h3 class="section-subtitle">🎁 @Localizer["Summary"]</h3>
                <div class="summary-grid">
                    <div class="summary-card-item christmas-card">
                        <div class="summary-icon">🎟️</div>
                        <div class="summary-details">
                            <h4>@Localizer["TotalTicketRevenue"]</h4>
                            <p class="revenue-amount">@(((dynamic)ViewBag.RevenueData)?.TotalTicketRevenue.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</p>
                            <p class="quantity-label">Số lượng vé: <strong>@(((dynamic)ViewBag.RevenueData)?.TotalTicketCount ?? 0)</strong></p>
                        </div>
                    </div>

                    <div class="summary-card-item christmas-card">
                        <div class="summary-icon">🍿</div>
                        <div class="summary-details">
                            <h4>@Localizer["TotalFoodRevenue"]</h4>
                            <p class="revenue-amount">@(((dynamic)ViewBag.RevenueData)?.TotalFoodRevenue.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</p>
                            <p class="quantity-label">Số lượng: <strong>@(((dynamic)ViewBag.RevenueData)?.TotalFoodCount ?? 0)</strong></p>
                        </div>
                    </div>

                    <div class="summary-card-item christmas-card">
                        <div class="summary-icon">🥤</div>
                        <div class="summary-details">
                            <h4>@Localizer["TotalDrinkRevenue"]</h4>
                            <p class="revenue-amount">@(((dynamic)ViewBag.RevenueData)?.TotalDrinkRevenue.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</p>
                            <p class="quantity-label">Số lượng: <strong>@(((dynamic)ViewBag.RevenueData)?.TotalDrinkCount ?? 0)</strong></p>
                        </div>
                    </div>

                    <div class="summary-card-item christmas-card">
                        <div class="summary-icon">🎁</div>
                        <div class="summary-details">
                            <h4>@Localizer["TotalComboRevenue"]</h4>
                            <p class="revenue-amount">@(((dynamic)ViewBag.RevenueData)?.TotalComboRevenue.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</p>
                            <p class="quantity-label">Số lượng: <strong>@(((dynamic)ViewBag.RevenueData)?.TotalComboCount ?? 0)</strong></p>
                        </div>
                    </div>

                    <div class="summary-card-item christmas-card highlight">
                        <div class="summary-icon">💰</div>
                        <div class="summary-details">
                            <h4>@Localizer["TotalRevenue"]</h4>
                            <p class="revenue-amount-large">@(((dynamic)ViewBag.RevenueData)?.TotalRevenue.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</p>
                            <p class="quantity-label">Tổng đơn hàng: <strong>@(((dynamic)ViewBag.RevenueData)?.TotalBookingCount ?? 0)</strong></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Detailed Food Item Statistics -->
            <div class="admin-section">
                <h3 class="section-subtitle">📊 Thống Kê Chi Tiết Món Ăn/Thức Uống</h3>
                <div class="table-responsive">
                    <table class="table table-custom christmas-table">
                        <thead>
                            <tr>
                                <th>Tên món</th>
                                <th>Danh mục</th>
                                <th>Số lượng bán</th>
                                <th>Doanh thu (VND)</th>
                                <th>Giá trung bình (VND)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var foodStats = ((dynamic)ViewBag.RevenueData)?.FoodItemStatistics as IEnumerable<dynamic> ?? new List<dynamic>();
                                if (foodStats.Any())
                                {
                                    foreach (var item in foodStats)
                                    {
                                        <tr>
                                            <td>@(item.Name ?? Localizer["N/A"].Value)</td>
                                            <td>
                                                @if (item.Category == "Food")
                                                {
                                                    <span class="badge badge-food">🍿 Thức ăn</span>
                                                }
                                                else if (item.Category == "Drink")
                                                {
                                                    <span class="badge badge-drink">🥤 Thức uống</span>
                                                }
                                                else if (item.Category == "Combo")
                                                {
                                                    <span class="badge badge-combo">🎁 Combo</span>
                                                }
                                                else
                                                {
                                                    <span>@(item.Category ?? Localizer["N/A"].Value)</span>
                                                }
                                            </td>
                                            <td><strong>@(item.TotalQuantity)</strong></td>
                                            <td>@(item.TotalRevenue?.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</td>
                                            <td>@(item.AveragePrice?.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="5" class="text-center">@Localizer["NoData"].Value</td></tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Revenue by Movie -->
            <div class="admin-section">
                <h3 class="section-subtitle">🎬 @Localizer["RevenueByMovie"]</h3>
                <div class="table-responsive">
                    <table class="table table-custom christmas-table">
                        <thead>
                            <tr>
                                <th>@Localizer["MovieTitle"]</th>
                                <th>@Localizer["TicketRevenue"] (VND)</th>
                                <th>@Localizer["TotalRevenue"] (VND)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var revenueByMovie = ((dynamic)ViewBag.RevenueData)?.RevenueByMovie as IEnumerable<dynamic> ?? new List<dynamic>();
                                if (revenueByMovie.Any())
                                {
                                    foreach (var item in revenueByMovie)
                                    {
                                        <tr>
                                            <td>@(item.MovieTitle ?? Localizer["N/A"].Value)</td>
                                            <td>@(item.TicketRevenue?.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</td>
                                            <td>@(item.TotalRevenue?.ToString("C", new System.Globalization.CultureInfo("vi-VN")) ?? Localizer["N/A"].Value)</td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="3" class="text-center">@Localizer["NoData"].Value</td></tr>
                                }
                            }
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Charts -->
            <div class="admin-section">
                <h3 class="section-subtitle">📈 @Localizer["RevenueChartByDate"]</h3>
                <div class="chart-container">
                    <canvas id="revenueByDateChart"></canvas>
                </div>
            </div>

            <div class="admin-section">
                <h3 class="section-subtitle">📈 @Localizer["RevenueChartByMonth"]</h3>
                <div class="chart-container">
                    <canvas id="revenueByMonthChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    body {
        margin: 0;
        background-color: #0F0F0F;
        color: #ffffff;
        font-family: 'Montserrat', sans-serif;
        overflow-x: hidden;
    }

    .content-inner {
        max-width: 1400px;
        width: 100%;
        padding: 30px;
    }

    .page-title {
        background: linear-gradient(90deg, #FFD700, #FF4500);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        font-size: 2.5rem;
        font-weight: 700;
        text-align: center;
        margin-bottom: 30px;
    }

    .christmas-icon {
        font-size: 2rem;
        animation: bounce 2s infinite;
    }

    .header-actions {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 15px;
        margin-bottom: 30px;
        flex-wrap: wrap;
    }

    .date-filter {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #FFD700;
    }

    .date-input {
        padding: 8px 12px;
        border-radius: 12px;
        border: 2px solid #FFD700;
        background-color: rgba(0, 0, 0, 0.3);
        color: #FFFAFA;
        font-weight: 500;
    }

    .christmas-btn {
        background: linear-gradient(135deg, #C41E3A, #165B33);
        border: 2px solid #FFD700;
        color: white;
        padding: 8px 20px;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s ease;
    }

        .christmas-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(255, 215, 0, 0.6);
        }

    .admin-section {
        margin-bottom: 50px;
    }

    .section-subtitle {
        font-size: 1.8rem;
        font-weight: 700;
        margin-bottom: 20px;
        color: #FFD700;
    }

    .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .christmas-card {
        background: linear-gradient(135deg, #8B0000, #165B33);
        border: 3px solid #FFD700;
        border-radius: 20px;
        padding: 25px;
        display: flex;
        align-items: center;
        gap: 20px;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3);
    }

        .christmas-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(255, 215, 0, 0.6);
        }

        .christmas-card.highlight {
            background: linear-gradient(135deg, #C41E3A, #FFD700);
            border-color: #FFFAFA;
        }

    .summary-icon {
        font-size: 3rem;
        min-width: 60px;
        text-align: center;
    }

    .summary-details h4 {
        color: #FFD700;
        font-size: 0.9rem;
        margin: 0 0 10px 0;
        text-transform: uppercase;
        font-weight: 600;
    }

    .revenue-amount {
        color: #98FB98;
        font-size: 1.5rem;
        font-weight: 700;
        margin: 5px 0;
    }

    .revenue-amount-large {
        color: #FFFAFA;
        font-size: 2rem;
        font-weight: 800;
        margin: 5px 0;
    }

    .quantity-label {
        color: #FFFAFA;
        font-size: 0.85rem;
        margin: 5px 0 0 0;
    }

    .christmas-table {
        width: 100%;
        background: #1c1c1c;
        border: 2px solid #FFD700;
        border-radius: 15px;
        overflow: hidden;
    }

        .christmas-table th {
            background: linear-gradient(135deg, #8B0000, #165B33);
            color: #FFFAFA;
            font-weight: 600;
            padding: 15px;
            border-bottom: 2px solid #FFD700;
        }

        .christmas-table td {
            background: #1c1c1c;
            color: #ffffff;
            padding: 12px 15px;
            border-bottom: 1px solid #FFD700;
        }

        .christmas-table tr:hover td {
            background: linear-gradient(90deg, rgba(139, 0, 0, 0.3), rgba(22, 91, 51, 0.3));
        }

    .badge {
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-food {
        background: #FFA726;
        color: #000;
    }

    .badge-drink {
        background: #42A5F5;
        color: #fff;
    }

    .badge-combo {
        background: #AB47BC;
        color: #fff;
    }

    .chart-container {
        background: rgba(0, 0, 0, 0.3);
        border: 2px solid #FFD700;
        border-radius: 15px;
        padding: 20px;
    }

    @@keyframes bounce {
        0%, 100%

    {
        transform: translateY(0);
    }

    50% {
        transform: translateY(-5px);
    }

    }

    @@media (max-width: 768px) {
        .page-title

    {
        font-size: 2rem;
    }

    .summary-grid {
        grid-template-columns: 1fr;
    }

    }
</style>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggleBtn = document.getElementById('sidebar-toggle');
            const sidebar = document.querySelector('.christmas-sidebar');
            const frameWrapper = document.querySelector('.frame-wrapper');

            if (toggleBtn && sidebar && frameWrapper) {
                toggleBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('collapsed');
                    frameWrapper.classList.toggle('shifted');

                    const icon = toggleBtn.querySelector('i');
                    if (sidebar.classList.contains('collapsed')) {
                        icon.className = 'fas fa-bars';
                    } else {
                        icon.className = 'fas fa-times';
                    }
                });
            }
        });

        $(document).ready(function () {
            $('#fromDate').val('@(((dynamic)ViewBag.RevenueData)?.FromDate ?? DateTime.Now.AddMonths(-1).ToString("yyyy-MM-dd"))');
            $('#toDate').val('@(((dynamic)ViewBag.RevenueData)?.ToDate ?? DateTime.Now.ToString("yyyy-MM-dd"))');

            function updateFilter() {
                $('#fromDateInput').val($('#fromDate').val());
                $('#toDateInput').val($('#toDate').val());
            }

            var revenueByDateData = JSON.parse('@Html.Raw(ViewBag.FormattedRevenueByDate ?? "[]")');
            var revenueByMonthData = JSON.parse('@Html.Raw(ViewBag.FormattedRevenueByMonth ?? "[]")');

            if (revenueByDateData.length > 0) {
                var ctxDate = document.getElementById('revenueByDateChart').getContext('2d');
                new Chart(ctxDate, {
                    type: 'bar',
                    data: {
                        labels: revenueByDateData.map(item => item.Date),
                        datasets: [
                            {
                                label: 'Vé (VND)',
                                data: revenueByDateData.map(item => item.TicketRevenue),
                                backgroundColor: 'rgba(255, 215, 0, 0.6)',
                                borderColor: 'rgba(255, 215, 0, 1)',
                                borderWidth: 2
                            },
                            {
                                label: 'Thức ăn (VND)',
                                data: revenueByDateData.map(item => item.FoodRevenue),
                                backgroundColor: 'rgba(196, 30, 58, 0.6)',
                                borderColor: 'rgba(196, 30, 58, 1)',
                                borderWidth: 2
                            },
                            {
                                label: 'Tổng (VND)',
                                data: revenueByDateData.map(item => item.TotalRevenue),
                                backgroundColor: 'rgba(22, 91, 51, 0.6)',
                                borderColor: 'rgba(22, 91, 51, 1)',
                                borderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#FFD700' },
                                grid: { color: 'rgba(255, 215, 0, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#FFFAFA' },
                                grid: { color: 'rgba(255, 215, 0, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#FFFAFA' } }
                        }
                    }
                });
            }

            if (revenueByMonthData.length > 0) {
                var ctxMonth = document.getElementById('revenueByMonthChart').getContext('2d');
                new Chart(ctxMonth, {
                    type: 'line',
                    data: {
                        labels: revenueByMonthData.map(item => item.Month),
                        datasets: [
                            {
                                label: 'Vé (VND)',
                                data: revenueByMonthData.map(item => item.TicketRevenue),
                                borderColor: 'rgba(255, 215, 0, 1)',
                                backgroundColor: 'rgba(255, 215, 0, 0.2)',
                                tension: 0.4,
                                borderWidth: 3
                            },
                            {
                                label: 'Thức ăn (VND)',
                                data: revenueByMonthData.map(item => item.FoodRevenue),
                                borderColor: 'rgba(196, 30, 58, 1)',
                                backgroundColor: 'rgba(196, 30, 58, 0.2)',
                                tension: 0.4,
                                borderWidth: 3
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#FFD700' },
                                grid: { color: 'rgba(255, 215, 0, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#FFFAFA' },
                                grid: { color: 'rgba(255, 215, 0, 0.1)' }
                            }
                        },
                        plugins: {
                            legend: { labels: { color: '#FFFAFA' } }
                        }
                    }
                });
            }
        });
    </script>
}