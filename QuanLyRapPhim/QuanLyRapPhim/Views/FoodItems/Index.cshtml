@using System.Linq
@model IEnumerable<QuanLyRapPhim.Models.FoodItem>
@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["FoodItemList"].Value;
    Layout = "~/Views/Shared/_Layout.cshtml";

    bool isAdmin = User.IsInRole("Admin");

    // Pagination
    var foodItemsList = Model.ToList();
    int pageSize = 5;
    int totalFoodItems = foodItemsList.Count;
    int totalPages = (int)Math.Ceiling((double)totalFoodItems / pageSize);

    int currentPage = ViewBag.CurrentPage != null ? (int)ViewBag.CurrentPage : 1;
    if (currentPage < 1) currentPage = 1;
    if (currentPage > totalPages && totalPages > 0) currentPage = totalPages;

    var paginatedFoodItems = foodItemsList
        .Skip((currentPage - 1) * pageSize)
        .Take(pageSize);
}

<div class="container mt-5">
    <div id="alert-container"></div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="text-danger fw-bold">
            <i class="fas fa-utensils"></i> @Localizer["FoodItemList"]
        </h2>

        @if (isAdmin)
        {
            <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addFoodItemModal">
                <i class="fas fa-plus"></i> @Localizer["AddFoodItem"]
            </button>
        }
    </div>

    @if (paginatedFoodItems.Any())
    {
        <div class="table-responsive">
            <table class="table table-hover table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>@Localizer["Image"]</th>
                        <th>@Localizer["Name"]</th>
                        <th>@Localizer["Price"]</th>
                        <th>@Localizer["Category"]</th>
                        @if (isAdmin)
                        {
                            <th>@Localizer["Actions"]</th>
                        }
                    </tr>
                </thead>

                <tbody>
                    @foreach (var item in paginatedFoodItems)
                    {
                        <tr>
                            <td>
                                @if (!string.IsNullOrEmpty(item.ImageUrl))
                                {
                                    <img src="@item.ImageUrl" alt="@item.Name"
                                         style="width:80px; height:80px; object-fit:cover; border-radius:8px;" />
                                }
                                else
                                {
                                    <div style="width:80px; height:80px; background:#ddd; border-radius:8px;
                                                display:flex; align-items:center; justify-content:center;">
                                        <i class="fas fa-image" style="font-size:24px; color:#999;"></i>
                                    </div>
                                }
                            </td>

                            <td>@item.Name</td>

                            <td class="text-danger fw-bold">@item.Price.ToString("N0") VNĐ</td>

                            <td>@(item.Category ?? "N/A")</td>

                            @if (isAdmin)
                            {
                                <td>
                                    <button class="btn btn-sm btn-warning edit-fooditem-btn"
                                            data-id="@item.FoodItemId">
                                        <i class="fas fa-edit"></i> @Localizer["Edit"]
                                    </button>

                                    <button class="btn btn-sm btn-danger delete-fooditem-btn"
                                            data-id="@item.FoodItemId">
                                        <i class="fas fa-trash"></i> @Localizer["Delete"]
                                    </button>
                                </td>
                            }
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- PAGINATION -->
        <nav class="mt-3">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" href="?page=@(currentPage - 1)">
                        @Localizer["Previous"]
                    </a>
                </li>

                @for (int i = 1; i <= totalPages; i++)
                {
                    <li class="page-item @(i == currentPage ? "active" : "")">
                        <a class="page-link" href="?page=@i">@i</a>
                    </li>
                }

                <li class="page-item @(currentPage == totalPages ? "disabled" : "")">
                    <a class="page-link" href="?page=@(currentPage + 1)">
                        @Localizer["Next"]
                    </a>
                </li>
            </ul>
        </nav>
    }
    else
    {
        <div class="alert alert-info text-center">
            <i class="fas fa-info-circle"></i> @Localizer["NoFoodItemsAvailable"]
        </div>
    }
</div>

<!-- ADD FOOD MODAL -->
@if (isAdmin)
{
    <div class="modal fade" id="addFoodItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">@Localizer["AddFoodItem"]</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="add-fooditem-form" action="/Admin/AddFoodItem" method="post">
                        @Html.AntiForgeryToken()

                        <div class="mb-3">
                            <label class="form-label">@Localizer["Name"]</label>
                            <input type="text" name="Name" class="form-control" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@Localizer["Price"]</label>
                            <input type="number" name="Price" class="form-control" step="0.01" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@Localizer["ImageUrl"]</label>
                            <input type="text" name="ImageUrl" class="form-control" placeholder="https://example.com/image.jpg" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@Localizer["Category"]</label>
                            <select name="Category" class="form-control" required>
                                <option value="">-- @Localizer["SelectCategory"] --</option>
                                <option value="Drink">@Localizer["Drink"]</option>
                                <option value="Snack">@Localizer["Snack"]</option>
                                <option value="Combo">@Localizer["Combo"]</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-danger w-100">
                            <i class="fas fa-save"></i> @Localizer["Save"]
                        </button>
                    </form>
                </div>

            </div>
        </div>
    </div>
}

<!-- EDIT FOOD MODAL -->
@if (isAdmin)
{
    <div class="modal fade" id="editFoodItemModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header bg-warning">
                    <h5 class="modal-title">@Localizer["EditFoodItem"]</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <form id="edit-fooditem-form">
                        @Html.AntiForgeryToken()

                        <input type="hidden" id="edit-id" name="FoodItemId" />

                        <div class="mb-3">
                            <label class="form-label">@Localizer["Name"]</label>
                            <input type="text" id="edit-name" name="Name" class="form-control" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@Localizer["Price"]</label>
                            <input type="number" id="edit-price" name="Price" class="form-control" step="0.01" required />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@Localizer["ImageUrl"]</label>
                            <input type="text" id="edit-imageurl" name="ImageUrl" class="form-control" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">@Localizer["Category"]</label>
                            <select id="edit-category" name="Category" class="form-control" required>
                                <option value="Drink">@Localizer["Drink"]</option>
                                <option value="Snack">@Localizer["Snack"]</option>
                                <option value="Combo">@Localizer["Combo"]</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-save"></i> @Localizer["Save"]
                        </button>

                    </form>
                </div>

            </div>
        </div>
    </div>
}
