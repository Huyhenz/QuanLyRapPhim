@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - QuanLyRapPhim</title>

    <!-- Font tiếng Việt -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" />

    <!-- Custom CSS -->
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/QuanLyRapPhim.styles.css" asp-append-version="true" />

    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #F5A89A;
        }

        .navbar {
            background-color: #1C2526 !important;
            border-bottom: 1px solid #0F1213;
        }

        .navbar-brand {
            color: #FFDAB9 !important;
            font-weight: bold;
        }

        .nav-link {
            color: #FFDAB9 !important;
            transition: color 0.3s ease;
        }

            .nav-link:hover {
                color: #FFFFFF !important;
            }

        .navbar-toggler-icon {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='%23FFDAB9' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e") !important;
        }

        /* Language Switcher */
        .language-switcher {
            display: flex;
            align-items: center;
        }

        .btn-language {
            background-color: transparent;
            border: 2px solid #FFDAB9;
            color: #FFDAB9 !important;
            padding: 5px 15px;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            border-radius: 0;
        }

            .btn-language:first-child {
                border-top-left-radius: 20px;
                border-bottom-left-radius: 20px;
                border-right: 1px solid #FFDAB9;
            }

            .btn-language:last-child {
                border-top-right-radius: 20px;
                border-bottom-right-radius: 20px;
                border-left: 1px solid #FFDAB9;
            }

            .btn-language:hover {
                background-color: rgba(255, 218, 185, 0.1);
                color: #FFFFFF !important;
                border-color: #FFFFFF;
            }

            .btn-language.active {
                background-color: #FFDAB9;
                color: #1C2526 !important;
                border-color: #FFDAB9;
            }

        .flag-icon {
            width: 20px;
            height: 15px;
            object-fit: cover;
            border-radius: 2px;
        }

        @@media (max-width: 991px) {
            .language-switcher {
                margin-top: 10px;
                margin-bottom: 10px;
            }
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg shadow">
            <div class="container">

                <!-- Logo -->
                <a class="navbar-brand fw-bold" asp-area="" asp-controller="Home" asp-action="Index">
                    <i class="fas fa-film"></i> CinemaX
                </a>

                <!-- Navbar Toggler -->
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <div class="collapse navbar-collapse" id="navbarNav">

                    <!-- Menu -->
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link active" asp-area="" asp-controller="Home" asp-action="Index">
                                <i class="fas fa-home"></i> @Localizer["Home"]
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" asp-area="" asp-controller="Home" asp-action="Privacy">
                                <i class="fas fa-shield-alt"></i> @Localizer["Privacy"]
                            </a>
                        </li>
                    </ul>

                    <!-- NÚT CHUYỂN ĐỔI NGÔN NGỮ -->
                    <div class="language-switcher me-3">
                        <div class="btn-group" role="group">
                            <button type="button"
                                    class="btn btn-language @(System.Globalization.CultureInfo.CurrentCulture.Name == "vi" ? "active" : "")"
                                    onclick="changeLanguage('vi')">
                                <img src="https://flagcdn.com/w20/vn.png" alt="VN" class="flag-icon" /> VN
                            </button>
                            <button type="button"
                                    class="btn btn-language @(System.Globalization.CultureInfo.CurrentCulture.Name == "en" ? "active" : "")"
                                    onclick="changeLanguage('en')">
                                <img src="https://flagcdn.com/w20/us.png" alt="EN" class="flag-icon" /> ENG
                            </button>
                        </div>
                    </div>


                    <!-- Login Partial -->
                    <partial name="_LoginPartial" />
                </div>
            </div>
        </nav>
    </header>

    <div class="container">
        <main role="main" class="pb-3">
            @RenderBody()
        </main>
    </div>

    <footer class="bg-dark text-white py-5">
        <div class="container">
            <div class="row">

                <!-- Logo and Slogan -->
                <div class="col-md-3">
                    <img src="https://i.pinimg.com/736x/84/bb/7d/84bb7dc83f72e12a7098a5e31c484baf.jpg" alt="CinemaX Logo" height="50" />
                    <h5>CinemaX</h5>
                    <p>BE HAPPY, BE A STAR</p>
                </div>

                <!-- Tài khoản -->
                <div class="col-md-2">
                    <h5>@Localizer["Account"]</h5>
                    <ul class="list-unstyled">
                        @if (User.Identity.IsAuthenticated)
                        {
                            <li>
                                <span style="color: white !important; opacity: 1;">
                                    <i class="fas fa-user-circle me-1"></i> @Localizer["Hello"], @User.Identity.Name
                                </span>
                            </li>
                            <li>
                                <a href="/Identity/Account/Manage/Index" class="btn btn-outline-secondary">
                                    @Localizer["Profile"]
                                </a>
                            </li>
                            <li>
                                <a href="/Identity/Account/Logout" class="text-white text-decoration-none">
                                    @Localizer["Logout"]
                                </a>
                            </li>
                        }
                        else
                        {
                            <li>
                                <a href="/Identity/Account/Login" class="text-white text-decoration-none">
                                    @Localizer["Login"]
                                </a>
                            </li>
                            <li>
                                <a href="/Identity/Account/Register" class="text-white text-decoration-none">
                                    @Localizer["Register"]
                                </a>
                            </li>
                        }
                        <li>
                            <a href="#" class="text-white text-decoration-none">
                                @Localizer["Membership"]
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>

    <!-- CHATBOT ĐẸP NHƯ ẢNH – CHỈ THAY NÚT CHAT & SEND BẰNG ICON -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <div id="chatbot-container" style="position:fixed;bottom:20px;right:20px;z-index:9999;font-family:'Segoe UI',Roboto,sans-serif;">
        <!-- Nút mở chatbot: icon robot thay chữ "Chat" -->
        <div id="chatbot-toggle"
             style="background:#e50914;color:white;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 6px 20px rgba(229,9,20,0.4);font-size:28px;transition:transform 0.3s;">
            <i class="fas fa-robot"></i>
        </div>

        <!-- Hộp chat -->
        <div id="chatbot-box" style="display:none;position:absolute;bottom:76px;right:0;width:360px;height:520px;background:#fff;border-radius:18px;overflow:hidden;box-shadow:0 10px 35px rgba(0,0,0,0.2);border:1px solid #eee;flex-direction:column;">
            <!-- Header đỏ -->
            <div style="background:#e50914;color:white;padding:16px;text-align:center;font-weight:600;font-size:17px;position:relative;">
                Trợ lý đặt vé CinemaX
                <div style="position:absolute;top:12px;right:16px;font-size:22px;cursor:pointer;" onclick="document.getElementById('chatbot-box').style.display='none'">
                    x
                </div>
            </div>

            <!-- Tin nhắn -->
            <div id="chat-messages" style="flex:1;padding:16px;overflow-y:auto;background:#f8f9fa;display:flex;flex-direction:column;gap:12px;"></div>

            <!-- Ô nhập + nút gửi icon máy bay -->
            <div style="padding:12px 16px;background:#fff;border-top:1px solid #eee;display:flex;align-items:center;gap:10px;">
                <input type="text" id="chat-input" placeholder="Nhập tin nhắn..."
                       style="flex:1;padding:12px 16px;border-radius:30px;border:1px solid #ddd;outline:none;font-size:15px;background:#f9f9f9;">
                <button onclick="sendMessage()"
                        style="background:#e50914;color:white;width:42px;height:42px;border-radius:50%;border:none;cursor:pointer;font-size:19px;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 15px rgba(229,9,20,0.4);">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Mở/đóng chatbot
        document.getElementById('chatbot-toggle').onclick = () => {
            const box = document.getElementById('chatbot-box');
            box.style.display = box.style.display === 'flex' ? 'none' : 'flex';
            if (box.style.display === 'flex') {
                document.getElementById('chat-input').focus();
            }
        };

        // Thêm tin nhắn
        function addMessage(text, isUser = false) {
            const container = document.getElementById('chat-messages');
            const bubble = document.createElement('div');
            bubble.style.cssText = `
                max-width: 78%;
                padding: 11px 16px;
                border-radius: 18px;
                margin-bottom: 8px;
                word-wrap: break-word;
                font-size: 14.5px;
                line-height: 1.4;
                align-self: ${isUser ? 'flex-end' : 'flex-start'};
                background: ${isUser ? '#e50914' : '#ffffff'};
                color: ${isUser ? 'white' : '#333'};
                box-shadow: 0 2px 8px rgba(0,0,0,${isUser ? '0.15' : '0.08'});
            `;
            bubble.innerHTML = text;
            container.appendChild(bubble);
            container.scrollTop = container.scrollHeight;
        }

        // Gửi tin nhắn
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg) return;
            addMessage(msg, true);
            input.value = '';
            const res = await fetch('/api/chatbot/ask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ Message: msg })
            });
            const data = await res.json();
            addMessage(data.reply || "Xin lỗi, mình chưa hiểu. Bạn hỏi lại nhé!");
        }

        // Enter để gửi
        document.getElementById('chat-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') sendMessage();
        });

        // Lời chào khi mở lần đầu
        document.getElementById('chatbot-toggle').addEventListener('click', function firstGreeting() {
            if (document.getElementById('chat-messages').children.length === 0) {
                setTimeout(() => {
                    addMessage("Chào bạn! Mình là trợ lý đặt vé CinemaX<br>Hôm nay bạn muốn xem phim gì nào?");
                }, 600);
            }
            this.removeEventListener('click', firstGreeting);
        });
    </script>

    <!-- Scripts -->
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>

    <script>
        function changeLanguage(culture) {
            // Lấy URL hiện tại (bao gồm cả query string)
            var currentUrl = window.location.pathname + window.location.search;

            // Loại bỏ hash nếu có
            if (window.location.hash) {
                currentUrl += window.location.hash;
            }

            // Gọi API để set ngôn ngữ
            var setLanguageUrl = '/Localization/SetLanguage?culture=' + culture + '&returnUrl=' + encodeURIComponent(currentUrl);

            // Redirect
            window.location.href = setLanguageUrl;
        }

        // Cập nhật trạng thái active của button khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            var currentCulture = '@System.Globalization.CultureInfo.CurrentCulture.Name';
            document.querySelectorAll('.btn-language').forEach(function(btn) {
                btn.classList.remove('active');
            });
            document.querySelector('.btn-language[onclick*="' + currentCulture + '"]')?.classList.add('active');
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
